<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Career Result | Career Compass</title>

  <!-- Poppins -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg1: #001f3f;
      --bg2: #002f60;
      --accent: #00ccff;
      --card: rgba(255,255,255,0.05);
      --glass: rgba(255,255,255,0.04);
      --text: #e9f7ff;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: "Poppins", sans-serif;
      background: linear-gradient(135deg,var(--bg1),var(--bg2));
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      padding:28px;
    }
    nav{
      display:flex; gap:18px; align-items:center;
      margin-bottom:22px;
    }
    nav a{ color:var(--text); text-decoration:none; font-weight:600; opacity:.95; }
    .wrap{
      max-width:960px; margin:0 auto;
    }
    .card{
      background: linear-gradient(180deg, rgba(0,0,0,0.25), rgba(255,255,255,0.02));
      border-radius:12px; padding:22px; box-shadow: 0 6px 20px rgba(0,0,0,0.45);
      backdrop-filter: blur(6px);
      margin-bottom:18px;
    }

    .header{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      margin-bottom:12px;
    }
    .title{
      display:flex; gap:14px; align-items:center;
    }
    .title h1{ margin:0; font-size:20px; letter-spacing:0.2px; }
    .match{
      background:var(--card); padding:8px 12px; border-radius:8px; font-weight:700;
      color:var(--accent);
    }

    .desc{ margin-top:8px; opacity:0.95; line-height:1.5; }

    .layout{
      display:grid;
      grid-template-columns: 1fr 380px;
      gap:18px;
      align-items:start;
    }

    /* left column */
    .left .section{ margin-bottom:14px; }
    .skills-list{ display:flex; flex-direction:column; gap:8px; margin-top:8px; }
    .skill-pill{
      background: var(--glass); padding:8px 10px; border-radius:8px; display:inline-block; font-weight:600;
      color:var(--text);
    }

    /* roadmap/chart area */
    .roadmap-area{ background:linear-gradient(180deg, rgba(0,0,0,0.18), rgba(255,255,255,0.01)); padding:14px; border-radius:10px; }
    canvas{ width:100% !important; height:260px !important; }

    /* right column */
    .right .card{ padding:14px; }
    .timeline{ display:flex; flex-direction:column; gap:10px; margin-top:8px; }
    .step{
      display:flex; gap:12px; align-items:flex-start; background: rgba(255,255,255,0.02);
      padding:10px; border-radius:8px;
    }
    .step .num{ width:36px; height:36px; border-radius:50%; background:var(--accent); color:#002032; display:flex; align-items:center; justify-content:center; font-weight:700; }
    .step p{ margin:0; font-size:14px; }

    /* responsive */
    @media (max-width:920px){
      .layout{ grid-template-columns: 1fr; }
      canvas{ height:220px !important; }
    }

    .cta{
      margin-top:18px; display:flex; gap:10px; align-items:center;
    }
    .btn{
      background:var(--accent); color:#002032; border:none; padding:10px 14px; border-radius:8px; font-weight:700; cursor:pointer;
      text-decoration:none;
    }
    .link{
      color:var(--text); opacity:.9; text-decoration:underline; cursor:pointer;
      background:none; border:none; font-weight:600;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <nav>
      <a href="/">Home</a>
      <a href="/quiz">Quiz</a>
      <a href="/chat">Chat</a>
      <a href="/dashboard">Dashboard</a>
      <a href="/resources">Resources</a>
    </nav>

    <div class="card header">
      <div class="title">
        <svg width="36" height="36" viewBox="0 0 24 24" fill="none" aria-hidden>
          <circle cx="12" cy="12" r="10" fill="#00ccff" opacity="0.12"></circle>
          <path d="M12 7v10M7 12h10" stroke="#00ccff" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <div>
          <h1>ðŸŽ¯ Result â€” {{ career }}</h1>
          <div class="desc">{{ desc }}</div>
        </div>
      </div>

      <div class="match">{{ match_percent }}%</div>
    </div>

    <div class="layout">
      <!-- LEFT COLUMN -->
      <div class="left">
        <div class="card section">
          <h3>Suggested Skills</h3>
          <div class="skills-list">
            {% if skills %}
              {% for s in skills %}
                <span class="skill-pill">{{ s }}</span>
              {% endfor %}
            {% else %}
              <p style="opacity:.85">No skill data available for this career.</p>
            {% endif %}
          </div>
        </div>

        <div class="card section roadmap-area">
          <h3>Career Roadmap (visual)</h3>
          <canvas id="roadmapChart" aria-label="Career roadmap chart" role="img"></canvas>
          <div style="margin-top:10px; font-size:13px; opacity:.85">
            Tip: bars show suggested progress across stages â€” use the timeline on the right for concise steps.
          </div>
        </div>

        <div class="card section">
          <h3>Quick Actions</h3>
          <div class="cta">
            <a class="btn" href="/resources">Explore Resources</a>
            <a class="btn" href="/dashboard">Open Skill Tracker</a>
            <form method="get" action="/quiz" style="display:inline">
              <button class="btn" type="submit">Retake Quiz</button>
            </form>
          </div>
        </div>
      </div>

      <!-- RIGHT COLUMN -->
      <div class="right">
        <div class="card">
          <h3>Roadmap Steps</h3>
          <div class="timeline" id="timelineContainer">
            <!-- timeline steps are injected by JS below -->
          </div>
        </div>

        <div class="card" style="margin-top:12px;">
          <h3>Notes</h3>
          <p style="opacity:.9; margin:0;">
            Use this roadmap as a guideline â€” adapt based on your time and strengths. Build projects early and keep a living portfolio.
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Pass roadmap from Flask (ensure it's a list of objects: [{stage, progress}, ...]) -->
  <script>
    // roadmap is passed from Flask and rendered as safe JSON
    const roadmap = {{ roadmap | tojson | safe }};

    // --- Render timeline (right column) ---
    (function renderTimeline(){
      const container = document.getElementById('timelineContainer');
      container.innerHTML = '';
      if (!Array.isArray(roadmap) || roadmap.length === 0) {
        container.innerHTML = '<p style="opacity:.9">No roadmap available.</p>';
        return;
      }

      roadmap.forEach((r, idx) => {
        // support both {stage,progress} and plain string forms defensively
        const stage = (typeof r === 'object' && r.stage) ? r.stage : String(r);
        const progress = (typeof r === 'object' && r.progress) ? r.progress : Math.round(((idx+1)/roadmap.length)*100);

        const step = document.createElement('div');
        step.className = 'step';
        step.innerHTML = `
          <div class="num">${idx+1}</div>
          <div>
            <p style="font-weight:700; margin-bottom:6px;">${stage}</p>
            <small style="opacity:.85">Progress indicator: ${progress}%</small>
          </div>
        `;
        container.appendChild(step);
      });
    })();

    // --- Create Chart.js bar chart (left column) ---
    (function renderChart(){
      try {
        const ctx = document.getElementById('roadmapChart').getContext('2d');

        // Defensive conversion of roadmap to labels/data
        const labels = roadmap.map(r => (typeof r === 'object' && r.stage) ? r.stage : String(r));
        const data = roadmap.map((r, i) => {
          if (typeof r === 'object' && typeof r.progress === 'number') return r.progress;
          // fallback: distribute [25,50,75,100] scaled to roadmap length
          return Math.round(((i + 1) / labels.length) * 100);
        });

        // If a previous Chart instance exists on this canvas, destroy it first (prevents duplication)
        if (window._roadmapChartInstance) {
          try { window._roadmapChartInstance.destroy(); } catch(e){/*ignore*/}
        }

        window._roadmapChartInstance = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: 'Career Roadmap Progress',
              data: data,
              borderRadius: 8,
              barPercentage: 0.6,
              backgroundColor: labels.map((_,i) => {
                // subtle gradient-like color variation using accent
                return 'rgba(0,204,255,' + (0.7 - (i * 0.08)) + ')';
              })
            }]
          },
          options: {
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              title: {
                display: true,
                text: '{{ career }} Roadmap',
                color: '#e6faff',
                font: { size: 14, weight: '600' }
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    return context.parsed.y + '%';
                  }
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                max: 100,
                ticks: { stepSize: 25, color: '#dff8ff' },
                grid: { color: 'rgba(255,255,255,0.04)' }
              },
              x: {
                ticks: { color: '#dff8ff' },
                grid: { display: false }
              }
            }
          }
        });
      } catch (err) {
        console.error('Chart render error:', err);
        // If Chart fails, hide canvas and leave timeline only
        const canvas = document.getElementById('roadmapChart');
        if (canvas) canvas.style.display = 'none';
      }
    })();
  </script>
</body>
</html>
